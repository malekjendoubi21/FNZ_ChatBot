@{
    ViewData["Title"] = "Chat Assistant";
    var conversationId = ViewData["ConversationId"] as int?;
    var conversationTitle = ViewData["ConversationTitle"] as string;
    var messages = ViewData["Messages"] as List<ConversationHistory> ?? new List<ConversationHistory>();
    var conversations = ViewData["Conversations"] as List<Conversation> ?? new List<Conversation>();
}

@section Styles {
    <link rel="stylesheet" href="~/css/chat-modern.css" asp-append-version="true" />
}

<div class="modern-chat-container">
    <!-- Sidebar des conversations -->
    <div class="chat-sidebar">
        <div class="chat-sidebar-header">
            <button id="newChatBtn" class="new-chat-btn">
                <i class="fas fa-plus"></i>
                Nouvelle conversation
            </button>
        </div>
        
        <div class="conversations-list" id="conversationsList">
            <div class="conversations-title">
                <i class="fas fa-history me-2"></i>Conversations récentes
            </div>
            
            @if (conversations.Any())
            {
                foreach (var conv in conversations)
                {
                    <div class="conversation-item @(conversationId == conv.Id ? "active" : "")" 
                         data-conversation-id="@conv.Id">
                        <div class="conversation-title">@conv.Title</div>
                        <div class="conversation-preview">
                            @{
                                var lastMessage = messages.LastOrDefault()?.Question ?? "Nouvelle conversation";
                                var preview = lastMessage.Length > 50 ? lastMessage.Substring(0, 50) + "..." : lastMessage;
                            }
                            @preview
                        </div>
                        <div class="conversation-time">
                            @conv.LastActivity.ToString("dd/MM à HH:mm")
                        </div>
                    </div>
                }
            }
            else
            {
                <div class="text-center text-muted py-4">
                    <i class="fas fa-comments fa-2x mb-2 opacity-50"></i>
                    <p class="mb-0">Aucune conversation</p>
                </div>
            }
            
            <div class="mt-4 pt-3" style="border-top: 1px solid var(--chat-border);">
                <a href="@Url.Action("MyConversations")" class="btn btn-outline-primary btn-sm w-100">
                    <i class="fas fa-list me-2"></i>Voir toutes les conversations
                </a>
            </div>
        </div>
    </div>

    <!-- Zone de chat principale -->
    <div class="chat-main">
        <!-- En-tête du chat -->
        <div class="chat-header">
            <div class="chat-title">
                <div class="chat-avatar">
                    <i class="fas fa-robot"></i>
                </div>
                <div class="chat-info">
                    <h3 id="chatTitle">
                        @if (!string.IsNullOrEmpty(conversationTitle))
                        {
                            @conversationTitle
                        }
                        else
                        {
                            @("Assistant FNZ")
                        }
                    </h3>
                    <div class="chat-status" id="chatStatus">
                        <div class="status-indicator"></div>
                        En ligne
                    </div>
                </div>
            </div>
            
            <div class="chat-actions">
                @if (conversationId.HasValue)
                {
                    <button class="action-btn" title="Partager la conversation">
                        <i class="fas fa-share-alt"></i>
                    </button>
                    <button class="action-btn" title="Sauvegarder">
                        <i class="fas fa-bookmark"></i>
                    </button>
                }
                <button class="action-btn" title="Paramètres">
                    <i class="fas fa-cog"></i>
                </button>
            </div>
        </div>

        <!-- Zone des messages -->
        <div class="chat-messages" id="messagesContainer">
            @if (messages.Any())
            {
                foreach (var message in messages)
                {
                    <!-- Message utilisateur -->
                    <div class="message-wrapper user">
                        <div class="message-avatar user">
                            <i class="fas fa-user"></i>
                        </div>
                        <div class="message-content">
                            <div class="message-bubble user">
                                @message.Question
                            </div>
                            <div class="message-time">@message.CreatedDate.ToString("HH:mm")</div>
                            <div class="message-status">
                                <i class="fas fa-check-double status-icon status-read"></i>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Réponse assistant -->
                    <div class="message-wrapper bot">
                        <div class="message-avatar bot">
                            <i class="fas fa-robot"></i>
                        </div>
                        <div class="message-content">
                            <div class="message-bubble bot">
                                @Html.Raw(message.Response.Replace("\n", "<br />"))
                            </div>
                            <div class="message-time">@message.CreatedDate.ToString("HH:mm")</div>
                        </div>
                    </div>
                }
            }
            else
            {
                <!-- État vide -->
                <div class="chat-empty">
                    <div class="empty-icon">
                        <i class="fas fa-robot"></i>
                    </div>
                    <h3 class="empty-title">Bonjour ! 👋</h3>
                    <p class="empty-description">
                        Je suis votre assistant virtuel FNZ. Comment puis-je vous aider aujourd'hui ?
                    </p>
                    
                    <div class="empty-suggestions">
                        <div class="suggestion-chip">Comment puis-je vous aider ?</div>
                        <div class="suggestion-chip">Expliquez-moi les services FNZ</div>
                        <div class="suggestion-chip">Quelles sont vos fonctionnalités ?</div>
                        <div class="suggestion-chip">Comment démarrer ?</div>
                    </div>
                </div>
            }
        </div>

        <!-- Zone de saisie -->
        <div class="chat-input-area">
            <div class="chat-input-container">
                <div class="chat-input-wrapper">
                    <textarea 
                        id="chatInput" 
                        class="chat-input" 
                        placeholder="Tapez votre message ici..." 
                        rows="1"></textarea>
                    <div class="input-actions">
                        <button class="input-action" title="Joindre un fichier">
                            <i class="fas fa-paperclip"></i>
                        </button>
                        <button class="input-action" title="Emoji">
                            <i class="fas fa-smile"></i>
                        </button>
                    </div>
                </div>
                <button id="sendButton" class="send-button" disabled>
                    <i class="fas fa-paper-plane"></i>
                </button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script src="~/js/chat-modern.js" asp-append-version="true"></script>
    <script>
        // Configuration spécifique pour cette instance
        document.addEventListener('DOMContentLoaded', function() {
            // Définir l'ID de conversation actuel
            if (window.modernChat) {
                window.modernChat.currentConversationId = @(conversationId?.ToString() ?? "null");
            }
        });
    </script>
}
