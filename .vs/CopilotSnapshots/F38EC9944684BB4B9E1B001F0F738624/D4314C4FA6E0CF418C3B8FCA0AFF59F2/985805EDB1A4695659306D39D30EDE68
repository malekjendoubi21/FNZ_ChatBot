@{
    ViewData["Title"] = "Administration Recherche Sémantique";
}

<div class="container-fluid">
    <div class="row">
        <div class="col-md-12">
            <h2><i class="fas fa-brain me-2"></i>Administration Recherche Sémantique</h2>
            <hr>
        </div>
    </div>

    <!-- Statistiques générales -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card bg-primary text-white">
                <div class="card-body text-center">
                    <h4>@ViewBag.KnowledgeCount</h4>
                    <p>Éléments de base de connaissances</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-success text-white">
                <div class="card-body text-center">
                    <h4>@ViewBag.TotalQuestions</h4>
                    <p>Questions traitées</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-info text-white">
                <div class="card-body text-center">
                    <h4><i class="fas fa-search"></i></h4>
                    <p>Recherche sémantique</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-warning text-white">
                <div class="card-body text-center">
                    <h4><i class="fas fa-chart-line"></i></h4>
                    <p>ML.NET + Cosinus</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Test de la recherche sémantique -->
    <div class="row mb-4">
        <div class="col-md-8">
            <div class="card">
                <div class="card-header">
                    <h5><i class="fas fa-flask me-2"></i>Test de Recherche Sémantique</h5>
                </div>
                <div class="card-body">
                    <form method="post" asp-action="TestSemantic">
                        <div class="input-group mb-3">
                            <input type="text" class="form-control" name="testQuestion" 
                                   placeholder="Entrez une question pour tester la recherche sémantique..."
                                   value="@ViewBag.TestQuestion" required>
                            <button class="btn btn-primary" type="submit">
                                <i class="fas fa-play me-1"></i>Tester
                            </button>
                        </div>
                    </form>

                    @if (ViewBag.TestPerformed == true)
                    {
                        <div class="mt-3">
                            <h6><strong>Question testée :</strong></h6>
                            <p class="text-muted">@ViewBag.TestQuestion</p>
                            
                            <h6><strong>Réponse :</strong></h6>
                            <div class="alert alert-info">
                                @Html.Raw(ViewBag.TestResponse?.ToString()?.Replace("\n", "<br />"))
                            </div>
                            
                            <div class="row">
                                <div class="col-md-6">
                                    <small><strong>Temps de réponse :</strong> @ViewBag.ResponseTime ms</small>
                                </div>
                                <div class="col-md-6">
                                    <small><strong>Qualité :</strong> 
                                        <span class="badge bg-@(ViewBag.ResponseQuality.ToString().Contains("Excellente") ? "success" : 
                                                               ViewBag.ResponseQuality.ToString().Contains("Bonne") ? "primary" : 
                                                               ViewBag.ResponseQuality.ToString().Contains("Moyenne") ? "warning" : "danger")">
                                            @ViewBag.ResponseQuality
                                        </span>
                                    </small>
                                </div>
                            </div>
                        </div>
                    }
                </div>
            </div>
        </div>

        <div class="col-md-4">
            <div class="card">
                <div class="card-header">
                    <h5><i class="fas fa-tools me-2"></i>Actions</h5>
                </div>
                <div class="card-body">
                    <form method="post" asp-action="EnhanceKnowledge" class="mb-3">
                        <button type="submit" class="btn btn-warning w-100">
                            <i class="fas fa-magic me-1"></i>Enrichir la base de connaissances
                        </button>
                    </form>
                    
                    <a href="@Url.Action("Analytics")" class="btn btn-info w-100">
                        <i class="fas fa-chart-bar me-1"></i>Voir les Analytics
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Suggestions d'amélioration -->
    @if (ViewBag.Suggestions != null && ((List<string>)ViewBag.Suggestions).Any())
    {
        <div class="row">
            <div class="col-md-12">
                <div class="card">
                    <div class="card-header">
                        <h5><i class="fas fa-lightbulb me-2"></i>Suggestions d'Amélioration</h5>
                    </div>
                    <div class="card-body">
                        <ul class="list-group list-group-flush">
                            @foreach (var suggestion in (List<string>)ViewBag.Suggestions)
                            {
                                <li class="list-group-item">
                                    <i class="fas fa-exclamation-triangle text-warning me-2"></i>
                                    @suggestion
                                </li>
                            }
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    }

    <!-- Instructions -->
    <div class="row mt-4">
        <div class="col-md-12">
            <div class="card">
                <div class="card-header">
                    <h5><i class="fas fa-info-circle me-2"></i>Comment fonctionne la recherche sémantique</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <h6><strong>Étapes du processus :</strong></h6>
                            <ol>
                                <li><strong>Réponses standard</strong> - Vérification des salutations et questions courantes</li>
                                <li><strong>Recherche sémantique</strong> - Utilisation de ML.NET pour créer des embeddings</li>
                                <li><strong>Similarité cosinus</strong> - Calcul de la similarité entre la question et la base</li>
                                <li><strong>Recherche textuelle</strong> - Fallback si aucun résultat sémantique</li>
                                <li><strong>Formatage</strong> - Présentation des résultats trouvés</li>
                            </ol>
                        </div>
                        <div class="col-md-6">
                            <h6><strong>Fonctionnalités :</strong></h6>
                            <ul>
                                <li><i class="fas fa-check text-success me-1"></i>Recherche sémantique avec ML.NET</li>
                                <li><i class="fas fa-check text-success me-1"></i>Calcul de similarité cosinus</li>
                                <li><i class="fas fa-check text-success me-1"></i>Réponses standard pour questions courantes</li>
                                <li><i class="fas fa-check text-success me-1"></i>Mise en cache des embeddings</li>
                                <li><i class="fas fa-check text-success me-1"></i>Recherche textuelle de fallback</li>
                                <li><i class="fas fa-check text-success me-1"></i>Formatage intelligent des réponses</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        // Auto-refresh des suggestions
        function refreshSuggestions() {
            fetch('@Url.Action("Analytics")')
                .then(response => response.text())
                .then(data => {
                    console.log('Analytics mises à jour');
                })
                .catch(error => console.error('Erreur:', error));
        }

        // Actualiser toutes les 30 secondes
        setInterval(refreshSuggestions, 30000);
    </script>
}