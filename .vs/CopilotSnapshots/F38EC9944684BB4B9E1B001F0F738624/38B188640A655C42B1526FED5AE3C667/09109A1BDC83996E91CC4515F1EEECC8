@model List<FNZ_ChatBot.Models.ConversationHistory>
@{
    ViewData["Title"] = "Chat FNZ";
    var conversationId = ViewBag.ConversationId as int?;
    var userId = ViewBag.UserId as string;
    var questionSuggestions = ViewBag.QuestionSuggestions as List<FNZ_ChatBot.Controllers.QuestionSuggestion> ?? new List<FNZ_ChatBot.Controllers.QuestionSuggestion>();
}

<div class="chat-container">
    <!-- Header du chat -->
    <div class="chat-header">
        <div class="chat-header-content">
            <div class="chat-title">
                <div class="chat-avatar">
                    <i class="fas fa-robot"></i>
                </div>
                <div class="chat-info">
                    <h4 class="chat-name">Assistant FNZ</h4>
                    <span class="chat-status online">En ligne</span>
                </div>
            </div>
            <div class="chat-actions">
                <button class="chat-action-btn" id="suggestionsBtn" title="Suggestions de questions">
                    <i class="fas fa-lightbulb"></i>
                </button>
                <button class="chat-action-btn" id="settingsBtn" title="Paramètres">
                    <i class="fas fa-cog"></i>
                </button>
            </div>
        </div>
    </div>

    <!-- Zone des messages -->
    <div class="chat-messages" id="chatMessages">
        @if (ViewBag.ConversationHistory != null && ((List<FNZ_ChatBot.Models.ConversationHistory>)ViewBag.ConversationHistory).Any())
        {
            @foreach (var message in (List<FNZ_ChatBot.Models.ConversationHistory>)ViewBag.ConversationHistory)
            {
                <!-- Message utilisateur -->
                <div class="message-wrapper user">
                    <div class="message-avatar user">
                        <i class="fas fa-user"></i>
                    </div>
                    <div class="message-content">
                        <div class="message-bubble user">
                            @message.Question
                        </div>
                        <div class="message-time">@message.CreatedDate.ToString("HH:mm")</div>
                        <div class="message-status">
                            <i class="fas fa-check-double status-icon status-read"></i>
                        </div>
                    </div>
                </div>
                
                <!-- Réponse assistant -->
                <div class="message-wrapper bot">
                    <div class="message-avatar bot">
                        <i class="fas fa-robot"></i>
                    </div>
                    <div class="message-content">
                        <div class="message-bubble bot">
                            @Html.Raw(message.Response.Replace("\n", "<br />"))
                        </div>
                        <div class="message-time">@message.CreatedDate.ToString("HH:mm")</div>
                    </div>
                </div>
            }
        }
        else
        {
            <!-- État vide avec suggestions dynamiques -->
            <div class="chat-empty">
                <div class="empty-icon">
                    <i class="fas fa-robot"></i>
                </div>
                <h3 class="empty-title">Bonjour ! 👋</h3>
                <p class="empty-description">
                    Je suis votre assistant virtuel FNZ. Comment puis-je vous aider aujourd'hui ?
                </p>
                
                <!-- Suggestions dynamiques -->
                @if (questionSuggestions.Any())
                {
                    <div class="question-suggestions" id="questionSuggestions">
                        <h6 class="suggestions-title">Quelques idées pour commencer :</h6>
                        <div class="suggestions-grid">
                            @foreach (var suggestion in questionSuggestions)
                            {
                                <button type="button" class="suggestion-card" data-question="@suggestion.OriginalQuestion">
                                    <div class="suggestion-icon">@suggestion.Icon</div>
                                    <div class="suggestion-text">
                                        <span class="suggestion-category">@suggestion.Category</span>
                                        <span class="suggestion-question">@suggestion.DisplayQuestion</span>
                                    </div>
                                </button>
                            }
                        </div>
                        
                        <div class="suggestions-footer">
                            <button type="button" class="btn-refresh-suggestions" id="refreshSuggestions">
                                <i class="fas fa-sync-alt me-1"></i>
                                Autres suggestions
                            </button>
                        </div>
                    </div>
                }
                else
                {
                    <!-- Suggestions par défaut si aucune donnée -->
                    <div class="empty-suggestions">
                        <div class="suggestion-chip" data-question="Comment créer une connexion SQL ?">Comment créer une connexion SQL ?</div>
                        <div class="suggestion-chip" data-question="Comment cloner un repository Git ?">Comment cloner un repository Git ?</div>
                        <div class="suggestion-chip" data-question="Comment créer une API REST ?">Comment créer une API REST ?</div>
                        <div class="suggestion-chip" data-question="Comment faire une migration EF ?">Comment faire une migration EF ?</div>
                    </div>
                }
            </div>
        }
    </div>

    <!-- Zone de saisie -->
    <div class="chat-input-area">
        <div class="chat-input-container">
            <div class="chat-input-wrapper">
                <textarea 
                    id="chatInput" 
                    class="chat-input" 
                    placeholder="Tapez votre message ici..." 
                    rows="1"></textarea>
                <div class="input-actions">
                    <button class="input-action" id="attachBtn" title="Joindre un fichier">
                        <i class="fas fa-paperclip"></i>
                    </button>
                    <button class="input-action" id="emojiBtn" title="Emoji">
                        <i class="fas fa-smile"></i>
                    </button>
                </div>
            </div>
            <button id="sendButton" class="send-button" disabled>
                <i class="fas fa-paper-plane"></i>
            </button>
        </div>
        
        <!-- Indicateur de frappe -->
        <div class="typing-indicator" id="typingIndicator" style="display: none;">
            <div class="typing-dots">
                <span></span>
                <span></span>
                <span></span>
            </div>
            <span class="typing-text">Assistant FNZ est en train d'écrire...</span>
        </div>
    </div>

    <!-- Panel des suggestions (masqué par défaut) -->
    <div class="suggestions-panel" id="suggestionsPanel" style="display: none;">
        <div class="suggestions-panel-header">
            <h6><i class="fas fa-lightbulb me-2"></i>Suggestions de questions</h6>
            <button class="close-suggestions" id="closeSuggestions">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="suggestions-panel-content" id="suggestionsPanelContent">
            <!-- Sera rempli dynamiquement -->
        </div>
    </div>
</div>

<!-- CSS spécifiques pour le chat -->
<link href="~/css/chat-interface.css" rel="stylesheet" />
<link href="~/css/chat-suggestions.css" rel="stylesheet" />

@section Scripts {
    <script>
        // Configuration et initialisation du chat
        document.addEventListener('DOMContentLoaded', function() {
            // Initialiser les variables globales
            window.currentConversationId = @(conversationId?.ToString() ?? "null");
            
            // Éléments du DOM
            const chatInput = document.getElementById('chatInput');
            const sendButton = document.getElementById('sendButton');
            const chatMessages = document.getElementById('chatMessages');
            const typingIndicator = document.getElementById('typingIndicator');

            // Auto-resize du textarea
            function autoResizeTextarea() {
                if (!chatInput) return;
                
                chatInput.style.height = 'auto';
                const scrollHeight = chatInput.scrollHeight;
                const maxHeight = 120;
                
                if (scrollHeight <= maxHeight) {
                    chatInput.style.height = scrollHeight + 'px';
                } else {
                    chatInput.style.height = maxHeight + 'px';
                }
            }

            // Mettre à jour l'état du bouton d'envoi
            function updateSendButtonState() {
                if (!sendButton || !chatInput) return;
                
                const hasText = chatInput.value.trim().length > 0;
                sendButton.disabled = !hasText;
            }

            // Scroll automatique vers le bas
            function scrollToBottom() {
                if (chatMessages) {
                    chatMessages.scrollTop = chatMessages.scrollHeight;
                }
            }

            // Ajouter un message à l'interface
            function addMessage(content, type) {
                if (!chatMessages) return;

                const messageWrapper = document.createElement('div');
                messageWrapper.className = `message-wrapper ${type}`;
                
                const messageTime = new Date().toLocaleTimeString('fr-FR', { 
                    hour: '2-digit', 
                    minute: '2-digit' 
                });

                const avatarIcon = type === 'user' ? 'fas fa-user' : 'fas fa-robot';

                messageWrapper.innerHTML = `
                    <div class="message-avatar ${type}">
                        <i class="${avatarIcon}"></i>
                    </div>
                    <div class="message-content">
                        <div class="message-bubble ${type}">
                            ${content.replace(/\n/g, '<br>')}
                        </div>
                        <div class="message-time">${messageTime}</div>
                        ${type === 'user' ? '<div class="message-status"><i class="fas fa-check status-icon status-sent"></i></div>' : ''}
                    </div>
                `;

                chatMessages.appendChild(messageWrapper);
                scrollToBottom();

                // Cacher l'état vide
                const emptyState = document.querySelector('.chat-empty');
                if (emptyState) {
                    emptyState.style.display = 'none';
                }
            }

            // Afficher l'indicateur de frappe
            function showTypingIndicator() {
                if (typingIndicator) {
                    typingIndicator.style.display = 'flex';
                    scrollToBottom();
                }
            }

            // Cacher l'indicateur de frappe
            function hideTypingIndicator() {
                if (typingIndicator) {
                    typingIndicator.style.display = 'none';
                }
            }

            // Envoyer un message
            async function sendMessage() {
                const message = chatInput.value.trim();
                if (!message) return;

                // Ajouter le message utilisateur
                addMessage(message, 'user');
                
                // Vider l'input
                chatInput.value = '';
                autoResizeTextarea();
                updateSendButtonState();
                
                // Afficher l'indicateur de frappe
                showTypingIndicator();
                
                try {
                    const response = await fetch('@Url.Action("PostMessage", "Chat")', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            Question: message,
                            ConversationId: window.currentConversationId
                        })
                    });

                    const data = await response.json();
                    hideTypingIndicator();
                    
                    if (data.success) {
                        addMessage(data.response, 'bot');
                    } else {
                        addMessage(data.message || 'Erreur de communication', 'bot');
                    }
                } catch (error) {
                    hideTypingIndicator();
                    addMessage('Erreur de connexion. Veuillez réessayer.', 'bot');
                    console.error('Erreur chat:', error);
                }
            }

            // Event listeners
            if (chatInput) {
                chatInput.addEventListener('input', function() {
                    autoResizeTextarea();
                    updateSendButtonState();
                });

                chatInput.addEventListener('keydown', function(e) {
                    if (e.key === 'Enter' && !e.shiftKey) {
                        e.preventDefault();
                        sendMessage();
                    }
                });
            }

            if (sendButton) {
                sendButton.addEventListener('click', sendMessage);
            }

            // Gestion des suggestions de questions
            document.querySelectorAll('.suggestion-card, .suggestion-chip').forEach(button => {
                button.addEventListener('click', function() {
                    const question = this.getAttribute('data-question') || this.textContent.trim();
                    if (chatInput) {
                        chatInput.value = question;
                        chatInput.focus();
                        autoResizeTextarea();
                        updateSendButtonState();
                    }
                });
            });

            // Actualiser les suggestions
            document.getElementById('refreshSuggestions')?.addEventListener('click', function() {
                const button = this;
                const originalContent = button.innerHTML;
                button.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Chargement...';
                button.disabled = true;

                fetch('@Url.Action("GetQuestionSuggestions", "Chat")')
                    .then(response => response.json())
                    .then(data => {
                        updateSuggestions(data.suggestions);
                    })
                    .catch(error => {
                        console.error('Erreur:', error);
                    })
                    .finally(() => {
                        button.innerHTML = originalContent;
                        button.disabled = false;
                    });
            });

            // Panel des suggestions
            document.getElementById('suggestionsBtn')?.addEventListener('click', function() {
                const panel = document.getElementById('suggestionsPanel');
                if (panel.style.display === 'none') {
                    loadSuggestionsPanel();
                    panel.style.display = 'block';
                } else {
                    panel.style.display = 'none';
                }
            });

            document.getElementById('closeSuggestions')?.addEventListener('click', function() {
                document.getElementById('suggestionsPanel').style.display = 'none';
            });

            // Fonctions utilitaires
            function updateSuggestions(suggestions) {
                const container = document.querySelector('.suggestions-grid');
                if (!container) return;

                container.innerHTML = '';
                suggestions.forEach(suggestion => {
                    const button = document.createElement('button');
                    button.type = 'button';
                    button.className = 'suggestion-card';
                    button.setAttribute('data-question', suggestion.originalQuestion);
                    button.innerHTML = `
                        <div class="suggestion-icon">${suggestion.icon}</div>
                        <div class="suggestion-text">
                            <span class="suggestion-category">${suggestion.category}</span>
                            <span class="suggestion-question">${suggestion.displayQuestion}</span>
                        </div>
                    `;
                    
                    button.addEventListener('click', function() {
                        const question = this.getAttribute('data-question');
                        if (chatInput) {
                            chatInput.value = question;
                            chatInput.focus();
                            autoResizeTextarea();
                            updateSendButtonState();
                        }
                    });
                    
                    container.appendChild(button);
                });
            }

            function loadSuggestionsPanel() {
                const content = document.getElementById('suggestionsPanelContent');
                content.innerHTML = '<div class="loading">Chargement des suggestions...</div>';

                fetch('@Url.Action("GetQuestionSuggestions", "Chat")')
                    .then(response => response.json())
                    .then(data => {
                        content.innerHTML = '';
                        data.suggestions.forEach(suggestion => {
                            const item = document.createElement('div');
                            item.className = 'suggestion-item';
                            item.innerHTML = `
                                <span class="suggestion-icon">${suggestion.icon}</span>
                                <div class="suggestion-content">
                                    <span class="suggestion-category">${suggestion.category}</span>
                                    <span class="suggestion-text">${suggestion.displayQuestion}</span>
                                </div>
                            `;
                            item.addEventListener('click', function() {
                                if (chatInput) {
                                    chatInput.value = suggestion.originalQuestion;
                                    chatInput.focus();
                                    autoResizeTextarea();
                                    updateSendButtonState();
                                    document.getElementById('suggestionsPanel').style.display = 'none';
                                }
                            });
                            content.appendChild(item);
                        });
                    })
                    .catch(error => {
                        content.innerHTML = '<div class="error">Erreur lors du chargement des suggestions</div>';
                        console.error('Erreur:', error);
                    });
            }

            // Initialisation
            updateSendButtonState();
            scrollToBottom();
            if (chatInput) {
                chatInput.focus();
            }
        });
    </script>
}
