using MailKit.Net.Smtp;
using MimeKit;

namespace FNZ_ChatBot.Services
{
    public interface IEmailService
    {
        Task SendEmailAsync(string toEmail, string subject, string htmlMessage);
        Task SendNewUserCredentialsAsync(string toEmail, string firstName, string lastName, string tempPassword);
        Task SendPasswordResetCodeAsync(string toEmail, string firstName, string verificationCode);
    }

    public class EmailService : IEmailService
    {
        private readonly IConfiguration _configuration;
        private readonly ILogger<EmailService> _logger;

        public EmailService(IConfiguration configuration, ILogger<EmailService> logger)
        {
            _configuration = configuration;
            _logger = logger;
        }

        public async Task SendEmailAsync(string toEmail, string subject, string htmlMessage)
        {
            try
            {
                var message = new MimeMessage();
                message.From.Add(new MailboxAddress(
                    _configuration["EmailSettings:FromName"] ?? "FNZ ChatBot",
                    _configuration["EmailSettings:FromEmail"] ?? "malekeljendoubi@gmail.com"
                ));
                
                message.To.Add(new MailboxAddress("", toEmail));
                message.Subject = subject;

                var bodyBuilder = new BodyBuilder
                {
                    HtmlBody = htmlMessage
                };
                
                message.Body = bodyBuilder.ToMessageBody();

                using var client = new SmtpClient();

                // Pour développement, on simule l'envoi
                if (bool.TryParse(_configuration["EmailSettings:UseRealSmtp"], out var useReal) && useReal)
                {
                    await client.ConnectAsync(
                        _configuration["EmailSettings:SmtpServer"],
                        int.Parse(_configuration["EmailSettings:Port"] ?? "587"),
                        MailKit.Security.SecureSocketOptions.StartTls
                    );

                    await client.AuthenticateAsync(
                        _configuration["EmailSettings:Username"],
                        _configuration["EmailSettings:Password"]
                    );

                    await client.SendAsync(message);
                    await client.DisconnectAsync(true);
                    
                    _logger.LogInformation("Email envoyé avec succès à {Email}", toEmail);
                }
                else
                {
                    // Mode développement - log l'email au lieu de l'envoyer
                    _logger.LogInformation("EMAIL SIMULÉ - À: {Email}, Sujet: {Subject}, Contenu: {Content}", 
                        toEmail, subject, htmlMessage);
                }
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, "Erreur lors de l'envoi de l'email à {Email}", toEmail);
                throw;
            }
        }

        public async Task SendNewUserCredentialsAsync(string toEmail, string firstName, string lastName, string tempPassword)
        {
            var subject = "Bienvenue sur FNZ ChatBot - Vos identifiants de connexion";
            
            var htmlMessage = $@"
                <!DOCTYPE html>
                <html>
                <head>
                    <meta charset='utf-8'>
                    <style>
                        body {{ font-family: Arial, sans-serif; line-height: 1.6; color: #333; }}
                        .container {{ max-width: 600px; margin: 0 auto; padding: 20px; }}
                        .header {{ background-color: #007bff; color: white; padding: 20px; text-align: center; }}
                        .content {{ padding: 20px; background-color: #f8f9fa; }}
                        .credentials {{ background-color: white; padding: 15px; border-left: 4px solid #007bff; margin: 20px 0; }}
                        .warning {{ background-color: #fff3cd; padding: 15px; border-left: 4px solid #ffc107; margin: 20px 0; }}
                        .footer {{ text-align: center; color: #666; font-size: 12px; margin-top: 20px; }}
                    </style>
                </head>
                <body>
                    <div class='container'>
                        <div class='header'>
                            <h1>🤖 Bienvenue sur FNZ ChatBot</h1>
                        </div>
                        
                        <div class='content'>
                            <h2>Bonjour {firstName} {lastName},</h2>
                            
                            <p>Votre compte utilisateur a été créé avec succès par un administrateur. Voici vos identifiants de connexion :</p>
                            
                            <div class='credentials'>
                                <h3>Vos identifiants :</h3>
                                <p><strong>Email :</strong> {toEmail}</p>
                                <p><strong>Mot de passe temporaire :</strong> <code>{tempPassword}</code></p>
                            </div>
                            
                            <div class='warning'>
                                <h3>⚠️ Important :</h3>
                                <p>Pour des raisons de sécurité, vous devrez <strong>obligatoirement changer votre mot de passe</strong> lors de votre première connexion.</p>
                            </div>
                            
                            <h3>Comment vous connecter :</h3>
                            <ol>
                                <li>Rendez-vous sur la page de connexion du FNZ ChatBot</li>
                                <li>Utilisez votre email et le mot de passe temporaire ci-dessus</li>
                                <li>Suivez les instructions pour définir un nouveau mot de passe sécurisé</li>
                                <li>Commencez à utiliser votre assistant virtuel intelligent !</li>
                            </ol>
                            
                            <p>Si vous avez des questions ou rencontrez des difficultés, n'hésitez pas à contacter votre administrateur.</p>
                            
                            <p>Cordialement,<br>L'équipe FNZ ChatBot</p>
                        </div>
                        
                        <div class='footer'>
                            <p>Cet email a été généré automatiquement. Merci de ne pas répondre à cette adresse.</p>
                        </div>
                    </div>
                </body>
                </html>";

            await SendEmailAsync(toEmail, subject, htmlMessage);
        }

        public async Task SendPasswordResetCodeAsync(string toEmail, string firstName, string verificationCode)
        {
            var subject = "FNZ ChatBot - Code de réinitialisation de mot de passe";
            
            var htmlMessage = $@"
                <!DOCTYPE html>
                <html>
                <head>
                    <meta charset='utf-8'>
                    <style>
                        body {{ font-family: Arial, sans-serif; line-height: 1.6; color: #333; }}
                        .container {{ max-width: 600px; margin: 0 auto; padding: 20px; }}
                        .header {{ background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px; text-align: center; }}
                        .content {{ padding: 20px; background-color: #f8f9fa; }}
                        .code-box {{ background-color: white; padding: 20px; border-left: 4px solid #667eea; margin: 20px 0; text-align: center; }}
                        .code {{ font-size: 32px; font-weight: bold; letter-spacing: 5px; color: #667eea; font-family: monospace; }}
                        .warning {{ background-color: #fff3cd; padding: 15px; border-left: 4px solid #ffc107; margin: 20px 0; }}
                        .info {{ background-color: #cce7ff; padding: 15px; border-left: 4px solid #0084ff; margin: 20px 0; }}
                        .footer {{ text-align: center; color: #666; font-size: 12px; margin-top: 20px; }}
                    </style>
                </head>
                <body>
                    <div class='container'>
                        <div class='header'>
                            <h1>🔐 Réinitialisation de Mot de Passe</h1>
                            <p>FNZ ChatBot</p>
                        </div>
                        
                        <div class='content'>
                            <h2>Bonjour {firstName},</h2>
                            
                            <p>Vous avez demandé la réinitialisation de votre mot de passe. Voici votre code de vérification :</p>
                            
                            <div class='code-box'>
                                <h3>Code de Vérification</h3>
                                <div class='code'>{verificationCode}</div>
                                <p><small>Saisissez ce code sur la page de réinitialisation</small></p>
                            </div>
                            
                            <div class='warning'>
                                <h3>⚠️ Informations importantes :</h3>
                                <ul>
                                    <li><strong>Validité :</strong> Ce code expire dans 15 minutes</li>
                                    <li><strong>Usage unique :</strong> Le code ne peut être utilisé qu'une seule fois</li>
                                    <li><strong>Sécurité :</strong> Ne partagez jamais ce code avec quelqu'un d'autre</li>
                                </ul>
                            </div>
                            
                            <div class='info'>
                                <h3>💡 Comment procéder :</h3>
                                <ol>
                                    <li>Retournez sur la page de réinitialisation de mot de passe</li>
                                    <li>Saisissez votre adresse email : <strong>{toEmail}</strong></li>
                                    <li>Entrez le code de vérification ci-dessus</li>
                                    <li>Définissez votre nouveau mot de passe sécurisé</li>
                                </ol>
                            </div>
                            
                            <p>Si vous n'avez pas demandé cette réinitialisation, vous pouvez ignorer cet email en toute sécurité. Votre compte reste protégé.</p>
                            
                            <p>En cas de problème, contactez l'équipe d'administration à <a href='mailto:admin@fnz.tn'>admin@fnz.tn</a></p>
                            
                            <p>Cordialement,<br>L'équipe FNZ ChatBot</p>
                        </div>
                        
                        <div class='footer'>
                            <p>Cet email a été généré automatiquement. Merci de ne pas répondre à cette adresse.</p>
                            <p>© 2024 FNZ ChatBot - Tous droits réservés</p>
                        </div>
                    </div>
                </body>
                </html>";

            await SendEmailAsync(toEmail, subject, htmlMessage);
        }
    }
}